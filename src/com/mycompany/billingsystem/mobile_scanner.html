<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Barcode Scanner</title>
    <!-- Load the scanner library from the local server -->
    <script src="/html5-qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; background-color: #f0f2f5; }
        .container { max-width: 600px; width: 100%; text-align: center; padding: 20px; box-sizing: border-box; }
        #qr-reader { border: 2px solid #ccc; border-radius: 8px; overflow: hidden; }
        #status-message { margin-top: 15px; font-size: 1.1em; font-weight: bold; color: #333; min-height: 25px; }
        .header { background-color: #007bff; color: white; padding: 15px; width: 100%; text-align: center; }
        h1 { margin: 0; font-size: 1.5em; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Barcode Scanner</h1>
    </div>

    <div class="container">
        <div id="qr-reader"></div>
        <div id="status-message">Point camera at a product barcode</div>
    </div>

    <script>
        // **FIX 1: Wait for the entire page and scripts to load before running any code.**
        // This prevents the "Html5QrcodeScanner is not defined" error.
        document.addEventListener('DOMContentLoaded', () => {
            const statusMessage = document.getElementById('status-message');
            let isScanning = false; // **FIX 4: Flag to prevent rapid double scans.**

            function onScanSuccess(decodedText, decodedResult) {
                if (isScanning) return;
                isScanning = true;

                statusMessage.textContent = `Scanned: ${decodedText}. Sending...`;
                statusMessage.style.color = '#28a745';

                // Send the scanned barcode to the server
                fetch('/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: decodedText
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    setTimeout(() => {
                        statusMessage.textContent = 'Ready for next scan...';
                        statusMessage.style.color = '#333';
                        isScanning = false; 
                    }, 1500);
                })
                .catch(error => {
                    // **FIX 3: Provide clear feedback on connection errors.**
                    statusMessage.textContent = 'Connection Error!';
                    statusMessage.style.color = '#dc3545';
                    console.error('Error sending barcode:', error);
                    setTimeout(() => {
                        isScanning = false;
                    }, 1500);
                });
            }

            function onScanFailure(error) {
                // This function is called frequently, so we don't display errors here.
            }

            // **FIX 2: Use a try-catch block for robust scanner initialization.**
            // This handles cases where the browser might be incompatible or permissions are denied.
            try {
                let html5QrcodeScanner = new Html5QrcodeScanner(
                    "qr-reader",
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    /* verbose= */ false
                );
                html5QrcodeScanner.render(onScanSuccess, onScanFailure);
            } catch (e) {
                console.error("Error initializing scanner:", e);
                statusMessage.textContent = "Error: Could not start scanner.";
                statusMessage.style.color = '#dc3545';
            }
        });
    </script>
</body>
</html>

